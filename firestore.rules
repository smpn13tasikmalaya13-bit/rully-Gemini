rules_version = '2';

service cloud.firestore {
	match /databases/{database}/documents {


		// --- Helper functions ---
		function isAuthenticated() {
			return request.auth != null;
		}

		function isOwner(userId) {
			return request.auth != null && request.auth.uid == userId;
		}

		function isAdmin() {
			return isAuthenticated()
				&& exists(/databases/$(database)/documents/users/$(request.auth.uid))
				&& get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'ADMIN';
		}

		// Announcements: public read; only ADMIN may create/update/delete
		match /announcements/{announcementId} {
			allow read: if true;
			allow create, update, delete: if isAdmin();
		}

		// Users (profiles)
		match /users/{userId} {
			// Creation allowed if the authenticated user is creating their own profile,
			// or if an ADMIN creates a profile for another user (admin provisioning).
			allow create: if isOwner(userId) || isAdmin();

			// Owner or admin may read/update the profile. Only admin can delete.
			allow read, update: if isOwner(userId) || isAdmin();
			allow delete: if isAdmin();
		}

		// Default: allow read for authenticated users, deny writes unless matched above
		match /{document=**} {
			allow read: if request.auth != null;
			allow write: if false;
		}
	}
}